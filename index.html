<!DOCTYPE html>
<html lang="hi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>NexusChat Pro - Mobile App</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/peerjs/1.4.7/peerjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lottie-web/5.9.6/lottie.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="manifest" href="manifest.json">
    <style>
        :root {
            --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --premium-gradient: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            --cyber-gradient: linear-gradient(135deg, #00dbde 0%, #fc00ff 100%);
            --matrix-gradient: linear-gradient(135deg, #00b09b 0%, #96c93d 100%);
            --dark-bg: #0f0f1e;
            --darker-bg: #070711;
            --neon-blue: #00f3ff;
            --neon-pink: #ff00c8;
            --neon-green: #00ff9d;
            --glass-bg: rgba(255, 255, 255, 0.1);
            --glass-border: rgba(255, 255, 255, 0.2);
            --text-light: #ffffff;
            --text-glow: 0 0 10px currentColor;
            --transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            --header-height: 60px;
            --footer-height: 70px;
            --safe-area-inset-top: env(safe-area-inset-top);
            --safe-area-inset-bottom: env(safe-area-inset-bottom);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }
        
        html, body {
            height: 100%;
            overflow: hidden;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: var(--dark-bg);
            color: var(--text-light);
            position: fixed;
            width: 100%;
        }

        body {
            padding-top: var(--safe-area-inset-top);
            padding-bottom: var(--safe-area-inset-bottom);
        }

        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: 
                radial-gradient(circle at 20% 80%, rgba(102, 126, 234, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 80% 20%, rgba(118, 75, 162, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 40% 40%, rgba(0, 243, 255, 0.05) 0%, transparent 50%);
            z-index: -1;
        }
        
        .cyber-grid {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: 
                linear-gradient(rgba(0, 243, 255, 0.1) 1px, transparent 1px),
                linear-gradient(90deg, rgba(0, 243, 255, 0.1) 1px, transparent 1px);
            background-size: 50px 50px;
            z-index: -1;
            opacity: 0.3;
        }
        
        .app-container {
            height: 100vh;
            width: 100%;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            position: relative;
        }

        /* Header Styles */
        .app-header {
            height: var(--header-height);
            background: rgba(15, 15, 30, 0.9);
            backdrop-filter: blur(20px);
            border-bottom: 1px solid var(--glass-border);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 15px;
            position: relative;
            z-index: 100;
            flex-shrink: 0;
        }

        .app-header::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 1px;
            background: linear-gradient(90deg, transparent, var(--neon-pink), transparent);
        }
        
        .logo {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .logo-icon {
            width: 40px;
            height: 40px;
            background: var(--cyber-gradient);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            box-shadow: 0 0 15px rgba(0, 219, 222, 0.5);
        }
        
        .logo-text {
            display: flex;
            flex-direction: column;
        }
        
        .logo-text h1 {
            font-size: 1.2em;
            background: var(--cyber-gradient);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            font-weight: 700;
        }
        
        .logo-text p {
            font-size: 0.7em;
            opacity: 0.8;
            margin-top: 1px;
        }
        
        .header-controls {
            display: flex;
            gap: 10px;
        }
        
        .header-btn {
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            color: var(--text-light);
            padding: 8px 12px;
            border-radius: 20px;
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 5px;
            font-weight: 500;
            font-size: 0.85em;
        }
        
        .header-btn:active {
            transform: scale(0.95);
        }
        
        /* Main Content Area */
        .app-content {
            flex: 1;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            padding: 15px;
            display: flex;
            flex-direction: column;
        }

        /* Connection Screen */
        .connection-screen {
            display: flex;
            flex-direction: column;
            height: 100%;
            overflow-y: auto;
        }
        
        .hero-section {
            text-align: center;
            margin-bottom: 25px;
            padding: 10px 0;
        }
        
        .hero-title {
            font-size: 2em;
            font-weight: 800;
            margin-bottom: 10px;
            background: linear-gradient(135deg, var(--neon-blue), var(--neon-pink));
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            line-height: 1.1;
        }
        
        .hero-subtitle {
            font-size: 0.9em;
            opacity: 0.8;
            margin-bottom: 20px;
            line-height: 1.4;
        }
        
        .feature-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-bottom: 25px;
        }
        
        .feature-card {
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            border-radius: 12px;
            padding: 15px;
            text-align: center;
            transition: var(--transition);
            backdrop-filter: blur(10px);
        }
        
        .feature-card:active {
            transform: scale(0.98);
        }
        
        .feature-icon {
            font-size: 1.8em;
            margin-bottom: 10px;
            background: var(--cyber-gradient);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
        }
        
        .feature-card h3 {
            font-size: 0.9em;
            margin-bottom: 5px;
        }
        
        .feature-card p {
            font-size: 0.75em;
            opacity: 0.8;
            line-height: 1.3;
        }
        
        .input-group {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-bottom: 20px;
        }
        
        .glass-input, .glass-select {
            padding: 15px;
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            border-radius: 12px;
            font-size: 1em;
            width: 100%;
            color: var(--text-light);
            transition: var(--transition);
        }
        
        .glass-input:focus, .glass-select:focus {
            outline: none;
            border-color: var(--neon-blue);
            box-shadow: 0 0 10px rgba(0, 243, 255, 0.3);
        }
        
        .glass-select {
            appearance: none;
            background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='white'%3e%3cpath d='M7 10l5 5 5-5z'/%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right 15px center;
            background-size: 15px;
        }
        
        .btn-group {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .btn {
            padding: 16px;
            border: none;
            border-radius: 12px;
            font-size: 1em;
            cursor: pointer;
            transition: var(--transition);
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        
        .btn:active {
            transform: scale(0.98);
        }
        
        .btn-primary {
            background: var(--cyber-gradient);
            color: white;
        }
        
        .btn-secondary {
            background: var(--glass-bg);
            color: var(--text-light);
            border: 1px solid var(--glass-border);
        }
        
        .btn-danger {
            background: var(--premium-gradient);
            color: white;
        }
        
        .your-id {
            background: var(--glass-bg);
            padding: 12px 15px;
            border-radius: 12px;
            font-size: 0.85em;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border: 1px solid var(--glass-border);
        }
        
        .your-id strong {
            color: var(--neon-green);
        }
        
        .copy-btn {
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            color: var(--text-light);
            padding: 6px 10px;
            border-radius: 20px;
            cursor: pointer;
            transition: var(--transition);
            font-size: 0.75em;
            display: flex;
            align-items: center;
            gap: 4px;
        }
        
        .copy-btn:active {
            transform: scale(0.95);
        }
        
        .status {
            padding: 12px 15px;
            border-radius: 12px;
            margin: 10px 0;
            font-weight: bold;
            text-align: center;
            backdrop-filter: blur(10px);
        }
        
        .status.waiting {
            background: rgba(255, 243, 205, 0.2);
            color: #ffd700;
            border: 1px solid rgba(255, 215, 0, 0.3);
        }
        
        .status.connected {
            background: rgba(212, 237, 218, 0.2);
            color: var(--neon-green);
            border: 1px solid rgba(0, 255, 157, 0.3);
        }
        
        .status.error {
            background: rgba(248, 215, 218, 0.2);
            color: #ff6b6b;
            border: 1px solid rgba(255, 107, 107, 0.3);
        }
        
        .loader {
            display: none;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            gap: 20px;
            padding: 30px 0;
        }
        
        .loader-animation {
            width: 100px;
            height: 100px;
        }

        /* Video Call Screen */
        .video-call-screen {
            display: none;
            flex-direction: column;
            height: 100%;
            overflow: hidden;
        }
        
        .video-call-screen.active {
            display: flex;
        }
        
        .video-section {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 10px;
            position: relative;
            overflow: hidden;
        }
        
        .video-container {
            position: relative;
            background: #000;
            border-radius: 12px;
            overflow: hidden;
            flex: 1;
            min-height: 0;
            border: 1px solid var(--glass-border);
        }
        
        video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .video-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            padding: 12px;
            background: linear-gradient(to bottom, rgba(0,0,0,0.5) 0%, transparent 20%, transparent 80%, rgba(0,0,0,0.5) 100%);
        }
        
        .video-label {
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.8em;
            align-self: flex-start;
            backdrop-filter: blur(10px);
            border: 1px solid var(--glass-border);
        }
        
        .video-controls {
            display: flex;
            justify-content: center;
            gap: 10px;
        }
        
        .control-btn {
            background: rgba(0,0,0,0.7);
            color: white;
            border: none;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: var(--transition);
            font-size: 1.1em;
            backdrop-filter: blur(10px);
            border: 1px solid var(--glass-border);
        }
        
        .control-btn:active {
            transform: scale(0.9);
        }
        
        .control-btn.active {
            background: var(--premium-gradient);
        }
        
        .avatar {
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            background: var(--cyber-gradient);
            color: white;
            font-size: 3em;
        }
        
        .call-controls {
            display: flex;
            justify-content: center;
            gap: 15px;
            padding: 15px;
            background: rgba(15, 15, 30, 0.8);
            backdrop-filter: blur(20px);
            border-top: 1px solid var(--glass-border);
        }
        
        .call-controls .control-btn {
            width: 60px;
            height: 60px;
        }
        
        .hud-element {
            position: absolute;
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            border-radius: 10px;
            padding: 8px 12px;
            backdrop-filter: blur(20px);
            z-index: 10;
            font-size: 0.8em;
        }
        
        .call-timer {
            top: 12px;
            right: 12px;
            color: var(--neon-green);
        }
        
        .connection-quality {
            bottom: 12px;
            left: 12px;
            color: var(--neon-blue);
        }
        
        .ai-features-panel {
            position: absolute;
            top: 12px;
            left: 12px;
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            border-radius: 12px;
            padding: 10px;
            z-index: 10;
            backdrop-filter: blur(20px);
            display: none;
        }
        
        .ai-feature {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 8px;
            padding: 6px 10px;
            border-radius: 20px;
            cursor: pointer;
            transition: var(--transition);
            font-size: 0.8em;
        }
        
        .ai-feature:active {
            transform: scale(0.95);
        }
        
        .ai-feature.active {
            background: rgba(0, 243, 255, 0.2);
            color: var(--neon-blue);
        }
        
        /* Chat Section */
        .chat-section {
            display: none;
            flex-direction: column;
            height: 100%;
            border: 1px solid var(--glass-border);
            border-radius: 12px;
            overflow: hidden;
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
        }
        
        .chat-section.active {
            display: flex;
        }
        
        .chat-header {
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.3) 0%, rgba(118, 75, 162, 0.3) 100%);
            color: white;
            padding: 12px 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--glass-border);
        }
        
        .chat-options {
            display: flex;
            gap: 8px;
        }
        
        .chat-options button {
            padding: 6px 10px;
            font-size: 0.75em;
        }
        
        .chat-box {
            flex: 1;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            padding: 15px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .message {
            padding: 10px 15px;
            border-radius: 18px;
            max-width: 85%;
            position: relative;
            word-wrap: break-word;
            backdrop-filter: blur(10px);
            border: 1px solid var(--glass-border);
            font-size: 0.9em;
        }
        
        .message.sent {
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.3) 0%, rgba(118, 75, 162, 0.3) 100%);
            color: white;
            align-self: flex-end;
            border-bottom-right-radius: 5px;
        }
        
        .message.received {
            background: rgba(255, 255, 255, 0.1);
            color: white;
            align-self: flex-start;
            border-bottom-left-radius: 5px;
        }
        
        .message-time {
            font-size: 0.65em;
            opacity: 0.7;
            margin-top: 4px;
            text-align: right;
        }
        
        .message-status {
            position: absolute;
            bottom: 6px;
            right: 10px;
            font-size: 0.65em;
        }
        
        .typing-indicator {
            padding: 8px 15px;
            font-style: italic;
            color: var(--neon-blue);
            align-self: flex-start;
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 0.8em;
        }
        
        .typing-dots {
            display: flex;
            gap: 3px;
        }
        
        .typing-dots span {
            width: 5px;
            height: 5px;
            border-radius: 50%;
            background: var(--neon-blue);
            animation: typing 1.4s infinite ease-in-out;
        }
        
        .typing-dots span:nth-child(1) { animation-delay: -0.32s; }
        .typing-dots span:nth-child(2) { animation-delay: -0.16s; }
        
        .chat-input-container {
            display: flex;
            padding: 12px;
            gap: 10px;
            border-top: 1px solid var(--glass-border);
        }
        
        .chat-input-container input {
            flex: 1;
            padding: 12px;
            border-radius: 20px;
        }
        
        .emoji-btn {
            background: transparent;
            border: none;
            font-size: 1.3em;
            cursor: pointer;
            padding: 8px;
            border-radius: 50%;
            transition: var(--transition);
        }
        
        .emoji-btn:active {
            background: rgba(255, 255, 255, 0.1);
        }
        
        /* Bottom Navigation */
        .bottom-nav {
            height: var(--footer-height);
            background: rgba(15, 15, 30, 0.9);
            backdrop-filter: blur(20px);
            border-top: 1px solid var(--glass-border);
            display: flex;
            align-items: center;
            justify-content: space-around;
            padding: 0 10px;
            flex-shrink: 0;
            position: relative;
            z-index: 100;
        }
        
        .bottom-nav::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 1px;
            background: linear-gradient(90deg, transparent, var(--neon-blue), transparent);
        }
        
        .nav-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 4px;
            padding: 8px 12px;
            border: none;
            background: transparent;
            color: var(--text-light);
            cursor: pointer;
            transition: var(--transition);
            border-radius: 10px;
            flex: 1;
            max-width: 80px;
        }
        
        .nav-btn:active {
            transform: scale(0.95);
        }
        
        .nav-btn.active {
            color: var(--neon-blue);
        }
        
        .nav-icon {
            font-size: 1.2em;
        }
        
        .nav-label {
            font-size: 0.7em;
            font-weight: 500;
        }
        
        /* Modals */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            padding: 20px;
            backdrop-filter: blur(10px);
        }
        
        .modal-content {
            background: var(--dark-bg);
            border-radius: 16px;
            padding: 25px;
            width: 100%;
            max-width: 400px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            border: 1px solid var(--glass-border);
            position: relative;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .close-modal {
            background: none;
            border: none;
            font-size: 1.3em;
            cursor: pointer;
            color: var(--text-light);
            transition: var(--transition);
        }
        
        .close-modal:active {
            transform: scale(0.9);
        }
        
        .settings-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 15px;
        }
        
        .setting-item {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .setting-item label {
            font-weight: 500;
            color: var(--neon-blue);
            font-size: 0.9em;
        }
        
        /* Notifications */
        .floating-notification {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            border-radius: 50px;
            padding: 12px 20px;
            backdrop-filter: blur(20px);
            z-index: 1000;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: var(--transition);
            opacity: 0;
            visibility: hidden;
            max-width: 90%;
            font-size: 0.9em;
        }
        
        .floating-notification.show {
            opacity: 1;
            visibility: visible;
            transform: translateX(-50%) translateY(0);
        }
        
        .network-status {
            position: fixed;
            top: 70px;
            right: 15px;
            padding: 8px 12px;
            border-radius: 20px;
            font-size: 0.7em;
            font-weight: bold;
            z-index: 1000;
            backdrop-filter: blur(10px);
            border: 1px solid var(--glass-border);
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .network-status.excellent {
            background: rgba(40, 167, 69, 0.2);
            color: var(--neon-green);
            border-color: rgba(0, 255, 157, 0.3);
        }
        
        .network-status.good {
            background: rgba(23, 162, 184, 0.2);
            color: var(--neon-blue);
            border-color: rgba(0, 243, 255, 0.3);
        }
        
        .network-status.poor {
            background: rgba(255, 193, 7, 0.2);
            color: #ffd700;
            border-color: rgba(255, 215, 0, 0.3);
        }
        
        .network-status.weak {
            background: rgba(220, 53, 69, 0.2);
            color: #ff6b6b;
            border-color: rgba(255, 107, 107, 0.3);
        }
        
        /* Animations */
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        
        @keyframes typing {
            0%, 60%, 100% { transform: translateY(0); }
            30% { transform: translateY(-3px); }
        }
        
        @keyframes slideUp {
            from { transform: translateY(100%); }
            to { transform: translateY(0); }
        }
        
        /* Responsive Adjustments */
        @media (max-width: 380px) {
            .feature-grid {
                grid-template-columns: 1fr;
            }
            
            .hero-title {
                font-size: 1.8em;
            }
            
            .nav-label {
                display: none;
            }
            
            .nav-btn {
                padding: 10px;
            }
        }
        
        @media (min-width: 768px) {
            .app-container {
                max-width: 768px;
                margin: 0 auto;
            }
        }
        
        /* Landscape Mode Adjustments */
        @media (max-height: 500px) and (orientation: landscape) {
            .app-header {
                height: 50px;
            }
            
            .bottom-nav {
                height: 60px;
            }
            
            .hero-section {
                margin-bottom: 15px;
            }
            
            .feature-grid {
                grid-template-columns: repeat(4, 1fr);
                margin-bottom: 15px;
            }
            
            .feature-card {
                padding: 10px;
            }
            
            .input-group {
                margin-bottom: 15px;
            }
        }
    </style>
</head>
<body>
    <div class="cyber-grid"></div>
    
    <div class="app-container">
        <!-- Header -->
        <header class="app-header">
            <div class="logo">
                <div class="logo-icon">
                    <i class="fas fa-satellite-dish"></i>
                </div>
                <div class="logo-text">
                    <h1>NexusChat</h1>
                    <p>Mobile Pro</p>
                </div>
            </div>
            <div class="header-controls">
                <button class="header-btn" id="themeToggle" onclick="toggleTheme()">
                    <i class="fas fa-moon"></i>
                </button>
                <button class="header-btn" id="settingsBtn" onclick="openSettings()">
                    <i class="fas fa-cogs"></i>
                </button>
            </div>
        </header>

        <!-- Main Content -->
        <main class="app-content" id="appContent">
            <!-- Connection Screen -->
            <div class="connection-screen" id="connectionScreen">
                <div class="hero-section">
                    <h1 class="hero-title">NexusChat Pro</h1>
                    <p class="hero-subtitle">God-Level Video Communication on Mobile</p>
                </div>
                
                <div class="your-id">
                    <div>
                        <strong>Your ID:</strong> <span id="myPeerId">Initializing...</span>
                    </div>
                    <button class="copy-btn" id="copyIdBtn" onclick="copyPeerId()">
                        <i class="fas fa-copy"></i> Copy
                    </button>
                </div>
                
                <div class="feature-grid">
                    <div class="feature-card">
                        <div class="feature-icon">
                            <i class="fas fa-robot"></i>
                        </div>
                        <h3>AI Powered</h3>
                        <p>Smart features and enhancements</p>
                    </div>
                    <div class="feature-card">
                        <div class="feature-icon">
                            <i class="fas fa-shield-alt"></i>
                        </div>
                        <h3>Secure</h3>
                        <p>Encrypted connections</p>
                    </div>
                    <div class="feature-card">
                        <div class="feature-icon">
                            <i class="fas fa-bolt"></i>
                        </div>
                        <h3>Fast</h3>
                        <p>Optimized performance</p>
                    </div>
                    <div class="feature-card">
                        <div class="feature-icon">
                            <i class="fas fa-vr-cardboard"></i>
                        </div>
                        <h3>Immersive</h3>
                        <p>Premium experience</p>
                    </div>
                </div>
                
                <div class="input-group">
                    <input type="text" id="remotePeerIdInput" class="glass-input" placeholder="Enter Peer ID">
                    <input type="password" id="roomPassword" class="glass-input" placeholder="Room Password (Optional)">
                    <select id="videoQuality" class="glass-select">
                        <option value="240">Low Quality</option>
                        <option value="480" selected>Medium Quality</option>
                        <option value="720">HD Quality</option>
                    </select>
                    <select id="aiFeatures" class="glass-select">
                        <option value="none">No AI Features</option>
                        <option value="backgroundBlur">Background Blur</option>
                        <option value="noiseCancellation">Noise Cancel</option>
                        <option value="transcription">Transcription</option>
                    </select>
                </div>
                
                <div class="btn-group">
                    <button id="connectBtn" class="btn btn-primary" onclick="connectToPeer()">
                        <i class="fas fa-plug"></i> Connect
                    </button>
                    <button id="randomBtn" class="btn btn-secondary" onclick="findRandomPeer()">
                        <i class="fas fa-random"></i> Random Chat
                    </button>
                </div>
                
                <div id="statusDiv" class="status"></div>
                
                <div class="loader" id="loader">
                    <div class="loader-animation" id="lottieLoader"></div>
                    <p>Connecting...</p>
                </div>
            </div>
            
            <!-- Video Call Screen -->
            <div class="video-call-screen" id="videoCallScreen">
                <div class="video-section">
                    <div class="ai-features-panel" id="aiPanel">
                        <div class="ai-feature active" onclick="toggleAI('backgroundBlur')">
                            <i class="fas fa-user-circle"></i>
                            <span>Blur BG</span>
                        </div>
                        <div class="ai-feature" onclick="toggleAI('backgroundReplace')">
                            <i class="fas fa-mountain"></i>
                            <span>Virtual BG</span>
                        </div>
                    </div>
                    
                    <div class="hud-element call-timer" id="callTimer">00:00:00</div>
                    <div class="hud-element connection-quality" id="connectionQuality">Connection: Excellent</div>
                    
                    <div class="video-container" id="localVideoContainer">
                        <video id="localVideo" autoplay muted playsinline></video>
                        <div class="video-overlay">
                            <div class="video-label">You</div>
                            <div class="video-controls">
                                <button class="control-btn" id="muteBtn" onclick="toggleMute()">
                                    <i class="fas fa-microphone"></i>
                                </button>
                                <button class="control-btn" id="videoBtn" onclick="toggleVideo()">
                                    <i class="fas fa-video"></i>
                                </button>
                            </div>
                        </div>
                        <div class="avatar" id="localAvatar" style="display:none;">
                            <i class="fas fa-user"></i>
                        </div>
                    </div>
                    
                    <div class="video-container" id="remoteVideoContainer">
                        <video id="remoteVideo" autoplay playsinline></video>
                        <div class="video-overlay">
                            <div class="video-label">Remote</div>
                            <div class="video-controls">
                                <button class="control-btn" onclick="toggleFullscreen('remoteVideo')">
                                    <i class="fas fa-expand"></i>
                                </button>
                                <button class="control-btn" onclick="reportUser()">
                                    <i class="fas fa-flag"></i>
                                </button>
                            </div>
                        </div>
                        <div class="avatar" id="remoteAvatar" style="display:none;">
                            <i class="fas fa-user-friends"></i>
                        </div>
                    </div>
                </div>
                
                <div class="call-controls">
                    <button class="control-btn" id="floatingMuteBtn" onclick="toggleMute()">
                        <i class="fas fa-microphone"></i>
                    </button>
                    <button class="control-btn" id="floatingVideoBtn" onclick="toggleVideo()">
                        <i class="fas fa-video"></i>
                    </button>
                    <button class="control-btn" id="screenShareBtn" onclick="toggleScreenShare()">
                        <i class="fas fa-desktop"></i>
                    </button>
                    <button class="control-btn btn-danger" onclick="disconnect()">
                        <i class="fas fa-phone-slash"></i>
                    </button>
                </div>
            </div>
            
            <!-- Chat Screen -->
            <div class="chat-section" id="chatScreen">
                <div class="chat-header">
                    <h3>Chat</h3>
                    <div class="chat-options">
                        <button class="btn btn-secondary" onclick="clearChat()">
                            <i class="fas fa-trash"></i>
                        </button>
                        <button class="btn btn-secondary" onclick="saveChat()">
                            <i class="fas fa-save"></i>
                        </button>
                    </div>
                </div>
                <div class="chat-box" id="chatBox">
                    <div class="typing-indicator" id="typingIndicator" style="display:none;">
                        <span>Remote is typing</span>
                        <div class="typing-dots">
                            <span></span>
                            <span></span>
                            <span></span>
                        </div>
                    </div>
                </div>
                <div class="chat-input-container">
                    <button class="emoji-btn" onclick="toggleEmojiPicker()">ðŸ˜€</button>
                    <input type="text" id="messageInput" class="glass-input" placeholder="Type a message..." onkeypress="handleEnter(event)" oninput="handleTyping()">
                    <button class="btn btn-primary" onclick="sendMessage()">
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </div>
            </div>
        </main>

        <!-- Bottom Navigation -->
        <nav class="bottom-nav">
            <button class="nav-btn active" id="navHome" onclick="showScreen('connection')">
                <i class="fas fa-home nav-icon"></i>
                <span class="nav-label">Home</span>
            </button>
            <button class="nav-btn" id="navCall" onclick="showScreen('video')">
                <i class="fas fa-video nav-icon"></i>
                <span class="nav-label">Call</span>
            </button>
            <button class="nav-btn" id="navChat" onclick="showScreen('chat')">
                <i class="fas fa-comments nav-icon"></i>
                <span class="nav-label">Chat</span>
            </button>
            <button class="nav-btn" id="navSettings" onclick="openSettings()">
                <i class="fas fa-cog nav-icon"></i>
                <span class="nav-label">Settings</span>
            </button>
        </nav>
    </div>

    <!-- Network Status Indicator -->
    <div class="network-status" id="networkStatus">
        <i class="fas fa-signal"></i> Excellent
    </div>

    <!-- Floating Notification -->
    <div class="floating-notification" id="floatingNotification">
        <i class="fas fa-check-circle"></i>
        <span id="notificationText">Notification message</span>
    </div>

    <!-- Settings Modal -->
    <div class="modal" id="settingsModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Settings</h2>
                <button class="close-modal" onclick="closeSettings()">Ã—</button>
            </div>
            <div class="settings-grid">
                <div class="setting-item">
                    <label for="videoQualitySetting">Video Quality</label>
                    <select id="videoQualitySetting" class="glass-select">
                        <option value="240">Low Quality</option>
                        <option value="480" selected>Medium Quality</option>
                        <option value="720">HD Quality</option>
                    </select>
                </div>
                <div class="setting-item">
                    <label for="noiseCancellation">Noise Cancellation</label>
                    <select id="noiseCancellation" class="glass-select">
                        <option value="off">Off</option>
                        <option value="low">Low</option>
                        <option value="medium">Medium</option>
                        <option value="high">High</option>
                    </select>
                </div>
                <div class="setting-item">
                    <label for="backgroundEffect">Background Effect</label>
                    <select id="backgroundEffect" class="glass-select">
                        <option value="none">None</option>
                        <option value="blur">Blur</option>
                        <option value="virtual">Virtual BG</option>
                    </select>
                </div>
                <div class="setting-item">
                    <label for="autoReconnect">Auto Reconnect</label>
                    <select id="autoReconnect" class="glass-select">
                        <option value="on">On</option>
                        <option value="off">Off</option>
                    </select>
                </div>
                <div class="setting-item">
                    <label for="inactivityTimeout">Inactivity Timeout</label>
                    <select id="inactivityTimeout" class="glass-select">
                        <option value="0">Off</option>
                        <option value="1">1 Minute</option>
                        <option value="3" selected>3 Minutes</option>
                        <option value="5">5 Minutes</option>
                    </select>
                </div>
            </div>
            <div style="margin-top: 20px; display: flex; gap: 10px;">
                <button class="btn btn-primary" onclick="applySettings()">
                    Apply Settings
                </button>
                <button class="btn btn-secondary" onclick="closeSettings()">
                    Cancel
                </button>
            </div>
        </div>
    </div>

    <!-- Emoji Picker Modal -->
    <div class="modal" id="emojiModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Select Emoji</h2>
                <button class="close-modal" onclick="closeEmojiPicker()">Ã—</button>
            </div>
            <div id="emojiContainer" style="display: grid; grid-template-columns: repeat(6, 1fr); gap: 8px; max-height: 300px; overflow-y: auto;">
                <!-- Emojis will be populated by JavaScript -->
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let peer;
        let myPeerId;
        let currentCall;
        let currentConnection;
        let localStream;
        let screenStream;
        let isMuted = false;
        let isVideoOff = false;
        let isScreenSharing = false;
        let currentCamera = 'user';
        let messageQueue = [];
        let isTyping = false;
        let typingTimeout;
        let isDarkTheme = true;
        let networkCheckInterval;
        let inactivityTimer;
        let isRecording = false;
        let mediaRecorder;
        let recordedChunks = [];
        let callStartTime;
        let callTimerInterval;
        let activeAI = [];
        let currentScreen = 'connection';

        // Common emojis for the emoji picker
        const emojis = ['ðŸ˜€', 'ðŸ˜ƒ', 'ðŸ˜„', 'ðŸ˜', 'ðŸ˜†', 'ðŸ˜…', 'ðŸ˜‚', 'ðŸ¤£', 'ðŸ˜Š', 'ðŸ˜‡', 'ðŸ™‚', 'ðŸ™ƒ', 'ðŸ˜‰', 'ðŸ˜Œ', 'ðŸ˜', 'ðŸ¥°', 'ðŸ˜˜', 'ðŸ˜—', 'ðŸ˜™', 'ðŸ˜š', 'ðŸ˜‹', 'ðŸ˜›', 'ðŸ˜', 'ðŸ˜œ', 'ðŸ¤ª', 'ðŸ¤¨', 'ðŸ§', 'ðŸ¤“', 'ðŸ˜Ž', 'ðŸ¤©', 'ðŸ¥³', 'ðŸ˜', 'ðŸ˜’', 'ðŸ˜ž', 'ðŸ˜”', 'ðŸ˜Ÿ', 'ðŸ˜•', 'ðŸ™', 'â˜¹ï¸', 'ðŸ˜£', 'ðŸ˜–', 'ðŸ˜«', 'ðŸ˜©', 'ðŸ¥º', 'ðŸ˜¢', 'ðŸ˜­', 'ðŸ˜¤', 'ðŸ˜ ', 'ðŸ˜¡', 'ðŸ¤¬', 'ðŸ¤¯', 'ðŸ˜³', 'ðŸ¥µ', 'ðŸ¥¶', 'ðŸ˜±', 'ðŸ˜¨', 'ðŸ˜°', 'ðŸ˜¥', 'ðŸ˜“', 'ðŸ¤—', 'ðŸ¤”', 'ðŸ¤­', 'ðŸ¤«', 'ðŸ¤¥', 'ðŸ˜¶', 'ðŸ˜', 'ðŸ˜‘', 'ðŸ˜¬', 'ðŸ™„', 'ðŸ˜¯', 'ðŸ˜¦', 'ðŸ˜§', 'ðŸ˜®', 'ðŸ˜²', 'ðŸ¥±', 'ðŸ˜´', 'ðŸ¤¤', 'ðŸ˜ª', 'ðŸ˜µ', 'ðŸ¥´', 'ðŸ¤¢', 'ðŸ¤®', 'ðŸ¤§', 'ðŸ˜·', 'ðŸ¤’', 'ðŸ¤•', 'ðŸ¤‘', 'ðŸ¤ ', 'ðŸ˜ˆ', 'ðŸ‘¿', 'ðŸ‘¹', 'ðŸ‘º', 'ðŸ¤¡', 'ðŸ’©', 'ðŸ‘»', 'ðŸ’€', 'â˜ ï¸', 'ðŸ‘½', 'ðŸ‘¾', 'ðŸ¤–', 'ðŸŽƒ', 'ðŸ˜º', 'ðŸ˜¸', 'ðŸ˜¹', 'ðŸ˜»', 'ðŸ˜¼', 'ðŸ˜½', 'ðŸ™€', 'ðŸ˜¿', 'ðŸ˜¾'];

        // Initialize PeerJS with free cloud server
        function initPeer() {
            peer = new Peer({
                config: {
                    'iceServers': [
                        { urls: 'stun:stun.l.google.com:19302' },
                        { urls: 'stun:stun1.l.google.com:19302' }
                    ]
                }
            });
            
            peer.on('open', (id) => {
                myPeerId = id;
                document.getElementById('myPeerId').textContent = id;
                showStatus('Ready to connect!', 'connected');
                startNetworkMonitoring();
                resetInactivityTimer();
                showNotification('App initialized successfully');
            });
            
            peer.on('call', (call) => {
                showStatus('Incoming call...', 'waiting');
                showNotification('Incoming call');
                
                // Check if room password is required
                const roomPassword = document.getElementById('roomPassword').value;
                if (roomPassword) {
                    // In a real app, we would verify the password with the caller
                    // For now, we'll just proceed
                }
                
                getLocalStream().then((stream) => {
                    localStream = stream;
                    document.getElementById('localVideo').srcObject = stream;
                    
                    call.answer(stream);
                    currentCall = call;
                    
                    call.on('stream', (remoteStream) => {
                        document.getElementById('remoteVideo').srcObject = remoteStream;
                        showScreen('video');
                        document.getElementById('aiPanel').style.display = 'block';
                        showStatus('Connected!', 'connected');
                        resetInactivityTimer();
                        startCallTimer();
                        showNotification('Call connected');
                    });
                    
                    call.on('close', () => {
                        disconnect();
                    });
                })
                .catch((err) => {
                    showStatus('Camera/mic access denied', 'error');
                    showNotification('Camera/mic access denied', 'error');
                });
            });
            
            peer.on('connection', (conn) => {
                currentConnection = conn;
                setupDataConnection(conn);
            });
            
            peer.on('error', (err) => {
                showStatus('Error: ' + err.type, 'error');
                showNotification('Connection error', 'error');
            });
            
            // Initialize Lottie loader
            if (typeof lottie !== 'undefined') {
                lottie.loadAnimation({
                    container: document.getElementById('lottieLoader'),
                    renderer: 'svg',
                    loop: true,
                    autoplay: true,
                    path: 'https://assets5.lottiefiles.com/packages/lf20_pojzngga.json'
                });
            }
        }
        
        // Show different screens
        function showScreen(screen) {
            // Hide all screens
            document.getElementById('connectionScreen').style.display = 'none';
            document.getElementById('videoCallScreen').classList.remove('active');
            document.getElementById('chatScreen').classList.remove('active');
            
            // Update nav buttons
            document.getElementById('navHome').classList.remove('active');
            document.getElementById('navCall').classList.remove('active');
            document.getElementById('navChat').classList.remove('active');
            
            // Show selected screen
            if (screen === 'connection') {
                document.getElementById('connectionScreen').style.display = 'flex';
                document.getElementById('navHome').classList.add('active');
                currentScreen = 'connection';
            } else if (screen === 'video') {
                document.getElementById('videoCallScreen').classList.add('active');
                document.getElementById('navCall').classList.add('active');
                currentScreen = 'video';
            } else if (screen === 'chat') {
                document.getElementById('chatScreen').classList.add('active');
                document.getElementById('navChat').classList.add('active');
                currentScreen = 'chat';
            }
        }
        
        // Copy Peer ID to clipboard
        function copyPeerId() {
            const peerId = document.getElementById('myPeerId').textContent;
            navigator.clipboard.writeText(peerId).then(() => {
                showNotification('ID copied to clipboard');
            }).catch(err => {
                console.error('Failed to copy: ', err);
                showNotification('Failed to copy ID', 'error');
            });
        }
        
        // Show floating notification
        function showNotification(message, type = 'success') {
            const notification = document.getElementById('floatingNotification');
            const notificationText = document.getElementById('notificationText');
            
            notificationText.textContent = message;
            
            if (type === 'error') {
                notification.innerHTML = '<i class="fas fa-exclamation-triangle"></i> ' + notification.innerHTML;
            }
            
            notification.classList.add('show');
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }
        
        // Start call timer
        function startCallTimer() {
            callStartTime = new Date();
            callTimerInterval = setInterval(() => {
                const now = new Date();
                const diff = new Date(now - callStartTime);
                
                const hours = diff.getUTCHours().toString().padStart(2, '0');
                const minutes = diff.getUTCMinutes().toString().padStart(2, '0');
                const seconds = diff.getUTCSeconds().toString().padStart(2, '0');
                
                document.getElementById('callTimer').textContent = `${hours}:${minutes}:${seconds}`;
            }, 1000);
        }
        
        // Toggle AI feature
        function toggleAI(feature) {
            const index = activeAI.indexOf(feature);
            const element = event.currentTarget;
            
            if (index === -1) {
                activeAI.push(feature);
                element.classList.add('active');
                showNotification(`${feature} activated`);
            } else {
                activeAI.splice(index, 1);
                element.classList.remove('active');
                showNotification(`${feature} deactivated`);
            }
            
            // In a real implementation, you would apply the AI feature here
            console.log('Active AI features:', activeAI);
        }
        
        // Get local media stream with selected quality
        function getLocalStream() {
            const videoQuality = document.getElementById('videoQuality').value;
            let constraints = {
                audio: {
                    echoCancellation: true,
                    noiseSuppression: true,
                    autoGainControl: true
                },
                video: {
                    width: { ideal: parseInt(videoQuality) * 16/9 },
                    height: { ideal: parseInt(videoQuality) },
                    frameRate: { ideal: 30 }
                }
            };
            
            return navigator.mediaDevices.getUserMedia(constraints);
        }
        
        function connectToPeer() {
            const remotePeerId = document.getElementById('remotePeerIdInput').value.trim();
            
            if (!remotePeerId) {
                showStatus('Please enter peer ID', 'error');
                return;
            }
            
            showStatus('Connecting...', 'waiting');
            document.getElementById('loader').style.display = 'flex';
            showNotification('Connecting...');
            
            getLocalStream()
                .then((stream) => {
                    localStream = stream;
                    document.getElementById('localVideo').srcObject = stream;
                    
                    const call = peer.call(remotePeerId, stream);
                    currentCall = call;
                    
                    call.on('stream', (remoteStream) => {
                        document.getElementById('remoteVideo').srcObject = remoteStream;
                        showScreen('video');
                        document.getElementById('loader').style.display = 'none';
                        document.getElementById('aiPanel').style.display = 'block';
                        showStatus('Connected!', 'connected');
                        resetInactivityTimer();
                        startCallTimer();
                        showNotification('Call connected');
                    });
                    
                    call.on('close', () => {
                        disconnect();
                    });
                    
                    const conn = peer.connect(remotePeerId);
                    currentConnection = conn;
                    setupDataConnection(conn);
                })
                .catch((err) => {
                    document.getElementById('loader').style.display = 'none';
                    showStatus('Camera/mic access denied', 'error');
                    showNotification('Camera/mic access denied', 'error');
                });
        }
        
        function setupDataConnection(conn) {
            conn.on('open', () => {
                console.log('Data connection established');
                // Send any queued messages
                while (messageQueue.length > 0) {
                    const message = messageQueue.shift();
                    conn.send(message);
                }
            });
            
            conn.on('data', (data) => {
                if (data.type === 'message') {
                    addMessage(data.text, 'received', data.timestamp);
                } else if (data.type === 'typing') {
                    if (data.typing) {
                        document.getElementById('typingIndicator').style.display = 'flex';
                    } else {
                        document.getElementById('typingIndicator').style.display = 'none';
                    }
                } else if (data.type === 'messageStatus') {
                    updateMessageStatus(data.messageId, data.status);
                }
            });
            
            conn.on('close', () => {
                document.getElementById('typingIndicator').style.display = 'none';
            });
        }
        
        function sendMessage() {
            const input = document.getElementById('messageInput');
            const message = input.value.trim();
            
            if (message) {
                const messageId = Date.now().toString();
                const timestamp = new Date().toLocaleTimeString();
                
                if (currentConnection && currentConnection.open) {
                    currentConnection.send({ 
                        type: 'message', 
                        text: message, 
                        timestamp: timestamp,
                        messageId: messageId
                    });
                    addMessage(message, 'sent', timestamp, messageId);
                    input.value = '';
                    
                    // Send typing stopped
                    if (isTyping) {
                        isTyping = false;
                        currentConnection.send({ type: 'typing', typing: false });
                    }
                } else {
                    // Queue the message if connection is not ready
                    messageQueue.push({ 
                        type: 'message', 
                        text: message, 
                        timestamp: timestamp,
                        messageId: messageId
                    });
                    addMessage(message, 'sent', timestamp, messageId);
                    input.value = '';
                }
            }
        }
        
        function addMessage(text, type, timestamp, messageId = null) {
            const chatBox = document.getElementById('chatBox');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${type}`;
            
            if (type === 'sent' && messageId) {
                messageDiv.innerHTML = `
                    ${text}
                    <div class="message-time">${timestamp}</div>
                    <div class="message-status" id="status-${messageId}">âœ“</div>
                `;
            } else {
                messageDiv.innerHTML = `
                    ${text}
                    <div class="message-time">${timestamp}</div>
                `;
            }
            
            chatBox.appendChild(messageDiv);
            chatBox.scrollTop = chatBox.scrollHeight;
            
            // If message is sent and we have a connection, simulate delivery and read status
            if (type === 'sent' && messageId && currentConnection && currentConnection.open) {
                setTimeout(() => {
                    updateMessageStatus(messageId, 'delivered');
                    if (currentConnection) {
                        currentConnection.send({ 
                            type: 'messageStatus', 
                            messageId: messageId, 
                            status: 'delivered' 
                        });
                    }
                }, 1000);
                
                setTimeout(() => {
                    updateMessageStatus(messageId, 'read');
                    if (currentConnection) {
                        currentConnection.send({ 
                            type: 'messageStatus', 
                            messageId: messageId, 
                            status: 'read' 
                        });
                    }
                }, 3000);
            }
        }
        
        function updateMessageStatus(messageId, status) {
            const statusElement = document.getElementById(`status-${messageId}`);
            if (statusElement) {
                if (status === 'delivered') {
                    statusElement.textContent = 'âœ“âœ“';
                } else if (status === 'read') {
                    statusElement.textContent = 'âœ“âœ“';
                    statusElement.style.color = 'var(--neon-green)';
                }
            }
        }
        
        function handleEnter(event) {
            if (event.key === 'Enter') {
                sendMessage();
            }
        }
        
        function handleTyping() {
            if (!isTyping && currentConnection && currentConnection.open) {
                isTyping = true;
                currentConnection.send({ type: 'typing', typing: true });
            }
            
            clearTimeout(typingTimeout);
            typingTimeout = setTimeout(() => {
                if (isTyping && currentConnection && currentConnection.open) {
                    isTyping = false;
                    currentConnection.send({ type: 'typing', typing: false });
                }
            }, 1000);
        }
        
        function toggleMute() {
            if (localStream) {
                const audioTracks = localStream.getAudioTracks();
                if (audioTracks.length > 0) {
                    isMuted = !isMuted;
                    audioTracks[0].enabled = !isMuted;
                    
                    const muteBtn = document.getElementById('muteBtn');
                    const floatingMuteBtn = document.getElementById('floatingMuteBtn');
                    
                    if (isMuted) {
                        muteBtn.innerHTML = '<i class="fas fa-microphone-slash"></i>';
                        muteBtn.classList.add('active');
                        floatingMuteBtn.innerHTML = '<i class="fas fa-microphone-slash"></i>';
                        floatingMuteBtn.classList.add('active');
                        showNotification('Microphone muted');
                    } else {
                        muteBtn.innerHTML = '<i class="fas fa-microphone"></i>';
                        muteBtn.classList.remove('active');
                        floatingMuteBtn.innerHTML = '<i class="fas fa-microphone"></i>';
                        floatingMuteBtn.classList.remove('active');
                        showNotification('Microphone active');
                    }
                }
            }
        }
        
        function toggleVideo() {
            if (localStream) {
                const videoTracks = localStream.getVideoTracks();
                if (videoTracks.length > 0) {
                    isVideoOff = !isVideoOff;
                    videoTracks[0].enabled = !isVideoOff;
                    
                    const videoBtn = document.getElementById('videoBtn');
                    const floatingVideoBtn = document.getElementById('floatingVideoBtn');
                    const localAvatar = document.getElementById('localAvatar');
                    
                    if (isVideoOff) {
                        videoBtn.innerHTML = '<i class="fas fa-video-slash"></i>';
                        videoBtn.classList.add('active');
                        floatingVideoBtn.innerHTML = '<i class="fas fa-video-slash"></i>';
                        floatingVideoBtn.classList.add('active');
                        localAvatar.style.display = 'flex';
                        showNotification('Camera off');
                    } else {
                        videoBtn.innerHTML = '<i class="fas fa-video"></i>';
                        videoBtn.classList.remove('active');
                        floatingVideoBtn.innerHTML = '<i class="fas fa-video"></i>';
                        floatingVideoBtn.classList.remove('active');
                        localAvatar.style.display = 'none';
                        showNotification('Camera on');
                    }
                }
            }
        }
        
        function toggleScreenShare() {
            if (!isScreenSharing) {
                // Start screen sharing
                if (navigator.mediaDevices && navigator.mediaDevices.getDisplayMedia) {
                    navigator.mediaDevices.getDisplayMedia({ video: true })
                        .then((stream) => {
                            screenStream = stream;
                            
                            // Replace the video track with screen share
                            const videoTrack = stream.getVideoTracks()[0];
                            const sender = currentCall.peerConnection.getSenders().find(
                                s => s.track && s.track.kind === 'video'
                            );
                            
                            if (sender) {
                                sender.replaceTrack(videoTrack);
                            }
                            
                            // Update UI
                            isScreenSharing = true;
                            document.getElementById('screenShareBtn').classList.add('active');
                            showNotification('Screen sharing started');
                            
                            // Handle when screen sharing is stopped
                            videoTrack.onended = () => {
                                toggleScreenShare();
                            };
                        })
                        .catch((err) => {
                            console.error('Error sharing screen:', err);
                            showNotification('Failed to share screen', 'error');
                        });
                }
            } else {
                // Stop screen sharing and revert to camera
                if (screenStream) {
                    screenStream.getTracks().forEach(track => track.stop());
                    
                    // Replace with camera track
                    const videoTrack = localStream.getVideoTracks()[0];
                    const sender = currentCall.peerConnection.getSenders().find(
                        s => s.track && s.track.kind === 'video'
                    );
                    
                    if (sender) {
                        sender.replaceTrack(videoTrack);
                    }
                    
                    // Update UI
                    isScreenSharing = false;
                    document.getElementById('screenShareBtn').classList.remove('active');
                    showNotification('Screen sharing stopped');
                }
            }
        }
        
        function toggleFullscreen(videoId) {
            const videoElement = document.getElementById(videoId);
            
            if (!document.fullscreenElement) {
                if (videoElement.requestFullscreen) {
                    videoElement.requestFullscreen();
                    showNotification('Fullscreen mode on');
                } else if (videoElement.webkitRequestFullscreen) {
                    videoElement.webkitRequestFullscreen();
                    showNotification('Fullscreen mode on');
                } else if (videoElement.msRequestFullscreen) {
                    videoElement.msRequestFullscreen();
                    showNotification('Fullscreen mode on');
                }
            } else {
                if (document.exitFullscreen) {
                    document.exitFullscreen();
                    showNotification('Fullscreen mode off');
                } else if (document.webkitExitFullscreen) {
                    document.webkitExitFullscreen();
                    showNotification('Fullscreen mode off');
                } else if (document.msExitFullscreen) {
                    document.msExitFullscreen();
                    showNotification('Fullscreen mode off');
                }
            }
        }
        
        function startNetworkMonitoring() {
            // Simulate network status changes for demo purposes
            // In a real app, you would use WebRTC statistics
            const statuses = ['excellent', 'good', 'poor', 'weak'];
            const statusTexts = [
                'Connection: Excellent',
                'Connection: Good',
                'Connection: Poor',
                'Connection: Weak'
            ];
            let currentStatus = 0;
            
            networkCheckInterval = setInterval(() => {
                const networkStatus = document.getElementById('networkStatus');
                networkStatus.textContent = statusTexts[currentStatus];
                networkStatus.className = `network-status ${statuses[currentStatus]}`;
                
                // Update connection quality HUD
                document.getElementById('connectionQuality').textContent = statusTexts[currentStatus];
                
                currentStatus = (currentStatus + 1) % statuses.length;
            }, 5000);
        }
        
        function resetInactivityTimer() {
            clearTimeout(inactivityTimer);
            
            const timeout = parseInt(document.getElementById('inactivityTimeout').value) * 60 * 1000;
            if (timeout > 0) {
                inactivityTimer = setTimeout(() => {
                    showStatus('Disconnected due to inactivity', 'error');
                    showNotification('Disconnected due to inactivity', 'error');
                    disconnect();
                }, timeout);
            }
        }
        
        function disconnect() {
            if (currentCall) {
                currentCall.close();
            }
            if (currentConnection) {
                currentConnection.close();
            }
            if (localStream) {
                localStream.getTracks().forEach(track => track.stop());
            }
            if (screenStream) {
                screenStream.getTracks().forEach(track => track.stop());
            }
            if (isRecording && mediaRecorder) {
                mediaRecorder.stop();
            }
            if (callTimerInterval) {
                clearInterval(callTimerInterval);
            }
            
            showScreen('connection');
            document.getElementById('aiPanel').style.display = 'none';
            document.getElementById('remoteVideo').srcObject = null;
            document.getElementById('localVideo').srcObject = null;
            document.getElementById('chatBox').innerHTML = '';
            document.getElementById('typingIndicator').style.display = 'none';
            document.getElementById('callTimer').textContent = '00:00:00';
            
            clearInterval(networkCheckInterval);
            clearTimeout(inactivityTimer);
            
            showStatus('Disconnected. Ready for new connection.', 'waiting');
            showNotification('Call ended');
        }
        
        function findRandomPeer() {
            // In a real implementation, this would connect to a signaling server
            // For demo purposes, we'll simulate finding a random peer
            showStatus('Searching for random peer...', 'waiting');
            document.getElementById('loader').style.display = 'flex';
            showNotification('Searching for random peer...');
            
            setTimeout(() => {
                document.getElementById('loader').style.display = 'none';
                showStatus('Random matching requires a signaling server. Please exchange IDs manually.', 'error');
                showNotification('Random connection requires server', 'error');
            }, 3000);
        }
        
        function showStatus(message, type) {
            const statusDiv = document.getElementById('statusDiv');
            statusDiv.className = `status ${type}`;
            statusDiv.textContent = message;
            statusDiv.style.display = 'block';
        }
        
        function toggleTheme() {
            // This is already in dark mode by default
            showNotification('Theme toggled');
        }
        
        function openSettings() {
            document.getElementById('settingsModal').style.display = 'flex';
        }
        
        function closeSettings() {
            document.getElementById('settingsModal').style.display = 'none';
        }
        
        function applySettings() {
            // Apply settings from the modal
            const videoQuality = document.getElementById('videoQualitySetting').value;
            document.getElementById('videoQuality').value = videoQuality;
            
            showStatus('Settings applied!', 'connected');
            showNotification('Settings applied');
            closeSettings();
        }
        
        function clearChat() {
            document.getElementById('chatBox').innerHTML = '';
            showNotification('Chat cleared');
        }
        
        function saveChat() {
            const chatBox = document.getElementById('chatBox');
            const messages = chatBox.querySelectorAll('.message');
            let chatText = 'NexusChat Pro - Chat Log\n';
            chatText += '==========================\n\n';
            
            messages.forEach(message => {
                const text = message.textContent || message.innerText;
                const time = message.querySelector('.message-time').textContent;
                const type = message.classList.contains('sent') ? 'You' : 'Stranger';
                chatText += `${time} - ${type}: ${text}\n`;
            });
            
            const blob = new Blob([chatText], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `chat-${new Date().toISOString()}.txt`;
            a.click();
            URL.revokeObjectURL(url);
            
            showStatus('Chat saved!', 'connected');
            showNotification('Chat saved');
        }
        
        function toggleEmojiPicker() {
            const emojiModal = document.getElementById('emojiModal');
            const emojiContainer = document.getElementById('emojiContainer');
            
            // Populate emojis if not already done
            if (emojiContainer.children.length === 0) {
                emojis.forEach(emoji => {
                    const emojiElement = document.createElement('div');
                    emojiElement.textContent = emoji;
                    emojiElement.style.fontSize = '1.5em';
                    emojiElement.style.cursor = 'pointer';
                    emojiElement.style.textAlign = 'center';
                    emojiElement.style.padding = '8px';
                    emojiElement.style.borderRadius = '8px';
                    emojiElement.style.transition = 'var(--transition)';
                    emojiElement.addEventListener('click', () => {
                        const input = document.getElementById('messageInput');
                        input.value += emoji;
                        input.focus();
                        closeEmojiPicker();
                    });
                    emojiElement.addEventListener('touchstart', () => {
                        emojiElement.style.backgroundColor = 'var(--glass-bg)';
                    });
                    emojiElement.addEventListener('touchend', () => {
                        emojiElement.style.backgroundColor = 'transparent';
                    });
                    emojiContainer.appendChild(emojiElement);
                });
            }
            
            emojiModal.style.display = 'flex';
        }
        
        function closeEmojiPicker() {
            document.getElementById('emojiModal').style.display = 'none';
        }
        
        function reportUser() {
            if (confirm('Report this user?')) {
                showStatus('User reported.', 'connected');
                showNotification('User reported');
                disconnect();
            }
        }
        
        // Initialize on load
        window.onload = () => {
            initPeer();
            
            // Set up event listeners for user activity to reset inactivity timer
            document.addEventListener('touchstart', resetInactivityTimer);
            document.addEventListener('touchend', resetInactivityTimer);
            document.addEventListener('click', resetInactivityTimer);
            
            // Initialize emoji picker
            toggleEmojiPicker();
            closeEmojiPicker();
            
            // Handle back button on Android
            if (window.history && window.history.pushState) {
                window.history.pushState(null, null, window.location.href);
                window.onpopstate = function() {
                    if (currentScreen !== 'connection') {
                        showScreen('connection');
                        window.history.pushState(null, null, window.location.href);
                    }
                };
            }
        };
    </script>
    <script>
if ("serviceWorker" in navigator) {
  navigator.serviceWorker.register("service-worker.js")
    .then(() => console.log("SW registered"))
    .catch(err => console.log("SW failed", err));
}
</script>

</body>
</html>
